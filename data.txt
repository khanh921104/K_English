CREATE DATABASE IF NOT EXISTS web_hoc_tieng_anh;
USE web_hoc_tieng_anh;

-- Bảng khách hàng
CREATE TABLE khach_hang (
    ma_kh INT AUTO_INCREMENT PRIMARY KEY,
    ho_ten VARCHAR(100),
    email VARCHAR(100),
    so_dien_thoai VARCHAR(20),
    ngay_dang_ky DATE DEFAULT CURRENT_DATE
);

-- Bảng tài khoản
CREATE TABLE tai_khoan (
    ten_dang_nhap VARCHAR(50) PRIMARY KEY,
    mat_khau VARCHAR(100),
    ma_kh INT,
    FOREIGN KEY (ma_kh) REFERENCES khach_hang(ma_kh) ON DELETE CASCADE
);

-- Bảng khóa học
CREATE TABLE khoa_hoc (
    ma_khoa INT AUTO_INCREMENT PRIMARY KEY,
    ten_khoa VARCHAR(100),
    mo_ta TEXT,
    cap_do ENUM('Sơ cấp', 'Trung cấp', 'Cao cấp'),
    gia DECIMAL(10,2),
    ma_gv INT,
    FOREIGN KEY (ma_gv) REFERENCES giao_vien(ma_gv)
        ON DELETE SET NULL
        ON UPDATE CASCADE
);

CREATE TABLE buoi_hoc (
    ma_buoi INT AUTO_INCREMENT PRIMARY KEY,
    ten_buoi VARCHAR(100),
    noi_dung TEXT,
    ngay_hoc DATE,
    ma_khoa INT,
    FOREIGN KEY (ma_khoa) REFERENCES khoa_hoc(ma_khoa)
        ON DELETE CASCADE
        ON UPDATE CASCADE
);

CREATE TABLE video_bai_giang (
    ma_video INT AUTO_INCREMENT PRIMARY KEY,
    ten_video VARCHAR(255),
    duong_dan_video VARCHAR(500),
    mo_ta TEXT,
    thoi_luong INT, -- tính bằng phút
    ma_buoi INT,
    FOREIGN KEY (ma_buoi) REFERENCES buoi_hoc(ma_buoi)
        ON DELETE CASCADE
        ON UPDATE CASCADE
);


-- Bảng đăng ký khóa học
CREATE TABLE dang_ky (
    ma_kh INT,
    ma_khoa INT,
    ngay_dang_ky DATE DEFAULT CURRENT_DATE,
    PRIMARY KEY (ma_kh, ma_khoa),
    FOREIGN KEY (ma_kh) REFERENCES khach_hang(ma_kh) ON DELETE CASCADE,
    FOREIGN KEY (ma_khoa) REFERENCES khoa_hoc(ma_khoa) ON DELETE CASCADE
);

CREATE TABLE tai_khoan (
    ma_tk INT AUTO_INCREMENT PRIMARY KEY,
    ten_dang_nhap VARCHAR(50) UNIQUE,
    mat_khau VARCHAR(100),
    vai_tro ENUM('GiaoVien', 'HocVien', 'Admin')
);

CREATE TABLE giao_vien (
    ma_gv INT AUTO_INCREMENT PRIMARY KEY,
    ho_ten VARCHAR(100),
    email VARCHAR(100),
    so_dien_thoai VARCHAR(20),
    chuyen_mon VARCHAR(100),
    trinh_do ENUM('Cử nhân', 'Thạc sĩ', 'Tiến sĩ'),
    ma_tk INT,
    FOREIGN KEY (ma_tk) REFERENCES tai_khoan(ma_tk)
        ON DELETE SET NULL
        ON UPDATE CASCADE
);

UPDATE buoi_hoc bh
JOIN video_bai_giang vbg ON bh.ma_buoi = vbg.ma_buoi
SET bh.thoi_luong = vbg.thoi_luong;

UPDATE buoi_hoc bh
JOIN (
    SELECT ma_buoi, SUM(thoi_luong) AS tong_thoi_luong
    FROM video_bai_giang
    GROUP BY ma_buoi
) AS video_sum ON bh.ma_buoi = video_sum.ma_buoi
SET bh.thoi_luong = video_sum.tong_thoi_luong;
